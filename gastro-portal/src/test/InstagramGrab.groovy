import groovy.json.JsonSlurper
import org.apache.commons.io.IOUtils

def tags = [
        "торт",
        "капкейк",
        "тортназаказ",
        "кейтеринг"
]

def filter = [
        "питер",
        "петербург",
        "спб",
        "812"
]

def cooks = [1538733845, 1560750992, 1682119582, 335253259, 1812853172, 310265572, 1581172282, 2056465565, 1779868135, 2121359612, 1825713013, 1953833758, 1348095957, 1591387458, 1555019557, 489200651, 1723133702, 1559311997, 1488635516, 1551452409, 1726974623, 1816838949, 1440733049, 376708476, 302412501, 1961020634, 406730385, 228283809, 2056626698, 552060087, 1463489325, 194257867, 1728014838, 1514608973, 1232291604, 272146702, 1641221778, 1996958155, 1707789265, 1747888438, 1420620271, 1492842721, 31895265, 1128795155, 777002231, 499731429, 1058092436, 1617608333, 1492310274, 2088220899, 480166757, 351335821, 1222428376, 226279706, 376907675, 353263318, 7097047, 617139983, 313503592, 922223485, 1243554844, 1505016718, 299685385, 1257772440, 1125778612, 1258284154, 1543662523, 973543162, 1381972760, 1942841278, 4234480, 1006289886, 1643819353, 1943729734, 1985723634, 842857150, 332116160, 39147778, 1309714744, 1625363170, 434295391, 1812997418, 1523724683, 1597358602, 1095541715, 1492822906, 1980149081, 1639903617, 538350063, 1918115060, 49897849, 1500733717, 1551926112, 1730553854, 592859094, 2036609877, 306678285, 1913031962, 816240633, 284431284, 1825286412, 1011112141, 2137818589, 1670774538, 1079849156, 1360610848, 1485542726, 1646620621, 1496457479, 1655061891, 1965665610, 1208281180, 859506195, 1696896931, 194872756, 516336689, 1493627695, 1410724509, 997058116, 2135820759, 1655159275, 494495879, 1653542884, 1620811141, 391959416, 1413098324, 1822349586, 1530113609, 687091421, 424565535, 1637485211, 1313659228, 582746994, 1371801135, 1636368195, 229779234, 1909780555, 1798290797, 17931723, 1314607926, 1952593550, 1905757113, 1540369688, 1946232984, 1984064879, 484688056, 1775666510, 1960632620, 10745034, 647107800, 1463249129, 2005689818, 1537299092, 1490703054, 1705972212, 1711689654, 1252700928, 2005430878, 1738286597, 6525171, 693538092, 437564827, 1393504729, 692602281, 532544409, 546276831, 1201009296, 25911839, 1686013219, 601651565, 1500717277, 1638682132, 1931764033, 1734438228, 528534035, 2138626324, 1548908016, 539239029, 1641210499, 337084623, 1678674694, 314933018, 1494922910, 1391006826, 471239745, 418073799, 812154764, 539766589, 292150977, 1452762247, 1561176773, 2099828741, 298681197, 1957831688, 1926160702, 1541387667, 2097432300, 2062034773, 400220057, 784608761, 248087312, 333902802, 1980470400, 1668829454, 298029161, 1688952223, 1599869751, 301103156, 179418859, 1181566177, 337658551, 1796572818, 1807987847, 24238720, 2092160640, 225013369, 415484680, 1442205133, 1510270917, 1622729626, 1807968330, 34175333, 479185570, 980996656, 1455231933, 316323133, 1256075387, 1597242791, 1452126078, 1108837025, 218660686, 42077151, 1944184168, 2121019491, 1247547311, 1224779167, 2092983771, 1734930050, 1594045984, 2115760468, 2002214421, 2087291995, 1207495804, 1623165280, 1573229956, 375466242, 1548156221, 1835720202, 1388922170, 1946600841, 1571111185, 1601666234, 1720603553, 1640237385, 569776442, 1046029248, 1363444417, 1417456663, 1166423833, 1632094792, 517411708, 1708068028, 213923965, 1799495144, 1542831570, 49186401, 353465067, 314683459, 2002515003, 226069666, 1240758075, 357927012, 309187549, 676628883, 1448633268, 269326062, 1462194113, 209307406, 1306415102, 2104230962, 757214159, 1592805583, 2090179109, 2066220937, 1321254854, 1465219562, 25723973, 1512035846, 1032992287, 836399969, 560125334, 639351701, 1985431024, 1571063022, 1219349601, 1959789326, 1505534614, 1495992391, 1819164412, 1390333592, 1692849672, 1953689313, 1734872822, 1509844153, 1583380753, 1923672911, 1712960906, 1307251863, 1412956569, 218260109, 1589008219, 1474723628, 1300147610, 1576599142, 845998443, 1593488192, 1343928196, 286844900, 1505126827, 1601152157, 1573239168, 1980203706, 2038201798, 1480738891, 412815819, 1439814067, 986991269, 1434688718, 1937431010, 211960426, 985635456, 1626875669, 715924803, 1963819103, 876946657, 1565562079, 1400917517, 1210926726, 297610919, 211577828, 251164023, 1550920212, 1939797072, 401094645, 1537660545, 392544865, 1701869597, 1638827880, 1553911162, 591120522, 1729681226, 1334425514, 477668200, 196749843, 536235341, 1820873289, 234057134, 201038407, 1761901627, 1595378907, 1985260471, 25936794, 1465132354, 1450658451, 1186469331, 1366820413, 345793893, 530160751, 1452844481, 1643457436, 1024230334, 1495889139, 1493329279, 778176129, 1823020310, 1427877906, 1294092963, 1342791362, 1817077511, 1803237808, 1004534104, 195493769, 1040551613, 1354547304, 400345474, 1723759246, 416095233, 19608892, 2094020727, 41419047, 598814281, 1699674783, 354872799, 1557369962, 1649621416, 379928676, 1492979822, 1401507914, 337181473, 2126198695, 1523025494, 595084941, 558785895, 1487377490, 1495031806, 298076033, 1527822498, 1159800674, 582462290, 1536726712, 353884232, 2064140455, 1837831242, 1815949347, 17925114, 1637079805, 332596380, 288561122, 1769849389, 381593175, 884214778, 1485432821, 250266924, 484208094, 1195516931, 1533081140, 264432795, 1144860533, 1594012087, 404564905, 1184042209, 1751116631, 184052593, 1934614739, 864396727, 233476837, 1562260813, 980740052, 499531058, 357545112, 909090678, 1513133258, 1242287227, 1411687227, 1664989566, 228147320, 259659490, 259631608, 233582941, 1507169128, 391190421, 639798085, 1595985176, 1416752343, 1236734236, 479203319, 1937002819, 741741665, 335521008, 1240619434, 2012537110, 346327779, 537673457, 1090621814, 1596732116, 1282980738, 1454554339, 1190674389, 805785035, 937348450, 2124976071, 187644811, 1572623432, 1265020964, 1655585211, 1447381090, 989831173, 1564828157, 1261390132, 1775986179, 466726155, 2060128152, 1041502098, 1083059430, 1109614308, 267057355, 1557412845, 1607641248, 1594052602, 2084865301, 1050486951, 1290492908, 1445876145, 1524893412, 1091406346, 879681072, 505586398, 475935636, 1916125141, 285554476, 1669150383, 2023012462, 1526861679, 190095730, 1642535966, 232449774, 1675569559, 477187726, 1193118606, 1547542938, 365625788, 1379904823, 1573222798, 1364414653, 839993819, 1534395473, 1201199484, 1653694020, 1511458708, 2114221024, 1671304848, 1434731875, 1555237114, 1463993041, 267481568, 1684155194, 1547282127, 292481207, 1541841715, 565233499, 967988804, 1939000302, 2122200282, 1930066830, 208532171, 1523892682, 1651209092, 15719202, 857141953, 245357281, 522928252, 352115514, 29517110, 1733240286, 1769302096, 1664778006, 522038984, 1420336499, 1806314072, 1489792782, 1999833651, 622154711, 270048070, 288149944, 2097672330, 1587238207, 1546622260, 2036936156, 317493560, 1612243836, 547583702, 1812803175, 32362853, 2106511115, 1695342391, 472607582, 2004938503, 551241194, 1296498244, 1981031685, 2004231687, 1653251051, 1565753354, 399370846, 1232400258, 1525295003, 608866343, 522268012, 1580038894, 173615039, 313913512, 2046143136, 1815225336, 1577236779, 1074078888, 2138008876, 1549688675, 1913229509, 1163096720, 786668875, 1946125159, 1480309517, 1948189096, 1798544932, 1799471815, 1629080847, 1749767927, 1812855832, 307942394, 1557470341, 691472469, 1719051936, 2116027153, 484474559, 1522985401, 1421261423, 529554767, 1554492533, 1963737730, 1609201867, 2095023499, 2133420820, 550164034, 1360791195, 1787261482, 2064812718, 2107228141, 546971658, 505634149, 1555208156, 2126207121, 1625649882, 2086439224, 341781608, 1497155589, 314119400, 1541938532, 964299941, 1923774213, 2050830013, 1737369387, 1752538334, 675658155, 1681615559, 1900625668, 1536456159, 280508177, 399839234, 343149269, 1905766709, 474052817, 729221658, 1984615521, 1785522093, 249875836, 2139272153, 1395082845, 2108111894, 1603053757, 1364475942, 1641269694, 283004480, 1468855978, 194005237, 318357511, 1689481495, 1721055864, 1409013615, 51208269, 1413166223, 798198832, 290070450, 1316648583, 1810177751, 1462876138, 2099726258, 1611154281, 1999622371, 1757211832, 1429873871, 1502705460, 597176574, 1493845445, 385453995, 1987820834, 1069122594, 1508793149, 2061420652, 1746802314, 2025819005, 685916630, 1831658005, 1708282544, 1972550619, 216730776, 1484400350, 1415603336, 1385246441, 21038854, 1990849889, 1687375546, 1967699352, 1928218927, 1805660289, 344752959, 230077291, 2041018425, 342967479, 1509090478, 1906136115, 1428371618, 1193557650, 2139406897, 2064487067, 1680342915, 1109527886, 864694959, 2001344508, 1590380081, 1838431705, 175650103, 1302753410, 1578215562, 267492812, 2137207902, 1961799698, 1061992971, 1582764014, 1345223499, 1755135888, 1557571589, 560445775, 1362195440, 510738666, 385953845, 47850177, 402133944, 1514741828, 1974181877, 1414593973, 377446961, 1412967432, 1581635943, 2018607387, 326638924, 1741274742, 1729932113, 1711753985, 756926704, 715150116, 210223154, 308419350, 1020704299, 1644429976, 1565060005, 37633617, 434300007, 2044082446, 1774068835, 892959548, 1134448814, 1816167675, 292437176, 489233526, 506371916, 712695288, 4831145, 1687109484, 1015579134, 1784839306, 1306891882, 508760405, 240971687, 1184610952, 1289932452, 214204103, 2100083284, 1328004816, 1806582695, 2106578675, 850535270, 2045010372, 474054294, 2082123920, 280601638, 2079270146, 1723687259, 1523822489, 951767685, 1499809459, 399725381, 1680215083, 303979894, 1419244814, 1653749553, 1969007196, 1571021751, 1923407330, 1148560460, 1675110332, 1901710162, 1410663337, 447249020, 202676206, 289574533, 1295061201, 1966203440, 502171607, 1902487099, 549084500, 183787832, 1799737577, 2031027258, 1995702813, 1743392674, 355669704, 999660096, 45803820, 926016785, 326931190, 50858864, 1536843680, 1403745246, 1541643893, 1184401659, 356225579, 269963108, 1514886471, 19081842, 1155286064, 1942837680, 1439059385, 1988121693, 621313129, 1421036346, 1720626763, 1239550407, 1919428739, 2028228739, 862259780, 1962222190, 1782775207, 1931031683, 525251528, 1283464345, 1602707141, 1971341294, 193556600, 1952023733, 2055802827, 298455122, 1697709851, 350655880, 1269040615, 1420689190, 617631434, 1450597078, 1688858396, 1420241437, 1521241153, 1646221310, 1349730506, 1381265752, 1725074217, 921631697, 604330039, 2007001854, 652381294, 2003807691, 1521166159, 914110011, 468376216, 1601527154, 1640168609, 261212082, 1539438445, 571266493, 1770486273, 1240660596, 2027416604, 2105818571, 1704954174, 1682187874, 305313889, 1008892582, 2037418363, 576430127, 38653691, 649017005, 1773895234, 1810905150, 2128623413, 1447288776, 1900002259, 507690413, 1907648988, 1534315290, 1992600364, 2022925280, 1174277747, 264495734, 520483419, 1435606356, 2101007416, 2090574894, 1956910081, 1396252113, 1996222304, 777144317, 420209224, 1544593419, 1449727289, 1684309645, 217670000, 1481983088, 391841780, 834705095, 263939565, 2114154462, 584076191, 44593236, 196880112, 1424046055, 303989016, 331151899, 310120060, 1902096990, 281966124, 490379538, 557268478, 273287950, 1652414408, 1304753774, 1546484076, 689862795, 219583484, 490187190, 235250118, 1713326999, 1778807662, 935635362, 1393592267, 1461750365, 1755813970, 1952228464, 298718942, 200062230, 2098528259, 1473912819, 480548197, 2099247008, 1466448171, 1523943111, 29871447, 1751024353, 1628617165, 1782130860, 349494873, 1590150425, 1657229311, 2084001603, 357201289, 1475231995, 9496766, 306913989, 481314587, 607042422, 1734476545, 592178334, 1790113185, 214000490, 1640216592, 358806936, 1590608086, 450342638, 1765883249, 1530070499, 469447364, 954623064, 1680993356, 1713129075, 2109613550, 1400216603, 1488715253, 1800105437, 2054626236, 1502679740, 1778589925, 1550155087, 415620520, 1475093775, 602614295, 509882447, 496775889, 271865828, 1336809082, 861587064, 879866556, 393146495, 1264801568, 2041286950, 287425508, 1949705385, 1707647250, 1754729693, 1986920537, 2022134104, 1245476298, 1340307761, 2021283693, 781845930, 1641225269, 1465202091, 2021689251, 499658081, 1471268353, 2080556666, 1256164528, 1994840323, 1950950978, 1445112619, 1559633349, 348151094, 1914044807, 1443512835, 1229272271, 470529006, 622326538, 1709784337, 1309024504, 1986123954, 2000088165, 1713153040, 587920500, 1902229373, 1743799520, 1315262175, 1161787629, 1495776547, 208090777, 1652291589, 1573390009, 2121221115, 1222770681, 2016629567, 21275200, 2119725207, 1496063967, 315465341, 1501759433, 480917184, 1104397933, 1211016117, 2033023933, 1359373097, 902388371, 1387324999, 1537340568, 563083715, 508778838, 1425204966, 187252550, 545877302, 1258603515, 1772107582, 2119229603, 16254939, 1333942979, 1785326631, 2124219523, 458528103, 1583297708, 2122096708, 1273191168, 1717523319, 1624179166, 231633764, 1826803862, 411734924, 437807634, 1835467396, 2083608950, 961258243, 224385198, 1449081302, 280739261, 1753183150, 2012497326, 2026870581, 1419250582, 1483543805, 1688819123, 1432064476, 234143351, 245124678, 1511305024, 1964621393, 2081307676, 1264661600, 2135328944, 1677668951, 1722072233, 1805315890, 1095944928, 1273831211, 335066394, 835773, 411669325, 1590515791, 1802318713, 2117709955, 1928917738, 822056033, 1313806095, 1970205564, 288552613, 1909414433, 903860913, 1564426884, 2094214431, 1683401571, 2116174962, 2125318733, 1964412666, 1450507444, 1040358718, 2032598296, 2084493783, 1056287401, 1750254996, 1362810524, 1832184593, 2022495891, 1590080895, 218566506, 1525877150, 221117669, 2030501166, 2136124280, 1535413724, 1396319379, 1584497428, 2036121886, 540646813, 261305343, 842427, 514935759, 236169117, 1405227168, 1347262646, 1808047200, 1490636935, 1395011972, 1303295890, 384342991, 538430348, 1565553184, 538949629, 2084404831, 783666028, 452324357, 336902445, 1251580019, 228251918, 358761180, 1559877523, 966128669, 2044133921, 1960585217, 2010578870, 1528570736, 220364714, 1524805248, 1432727371, 1461679201, 1697088913, 1835792359, 1677758447, 2060555813, 1791331564, 1329850961, 1292405342, 1982537846, 1914446469, 1369268398, 283505365, 1562391492, 1626717637, 596177629, 2048065394, 1590338294, 746018429, 675400488, 52893647, 1277309512, 447438273, 988398752, 193033189, 1440428514, 1573247437, 1482257084, 1453455184, 630866696, 646046678, 43034011, 1612433706, 1267694689, 2069325107, 1297959213, 288601927, 200090525, 373144539, 538249632, 1929765350, 927925878, 2024035984, 503710015, 1623552416, 1956818794, 940985863, 1358580193, 1671032364, 2121665706, 2052841298, 1502440717, 485388725, 316007074, 2100402168, 196910084, 1578889645, 1514470114, 1210087310, 1799128899, 1542036238, 555269022, 1450323729, 1542578448, 2117685048, 1680129338, 722541150, 1738735475, 1550741658, 1689032146, 1193619216, 416837241]

def localCooks = [1682119582, 1726974623, 532544409, 1201009296, 1980470400, 357927012, 209307406, 1823020310, 558785895, 1050486951, 1733240286, 2045010372, 2054626236, 1982537846, 485388725]

def fetchCooks(tags) {
    def cooks = [:]
    tags.eachWithIndex { tag, i ->
        def mediaUrl = "https://api.instagram.com/v1/tags/" + tag + "/media/recent?access_token=39949484.1fb234f.15ef9534744f42b68c22cf3b86b82687%20%20";
        def depth = 0
        while (mediaUrl && depth++ < 100) {
            println "calling " + mediaUrl;
            def getMediaPage = new URL(mediaUrl).openConnection() as HttpURLConnection
            getMediaPage.connect()
            def result = IOUtils.toString(getMediaPage.getInputStream()) as String
            def medias = new JsonSlurper().parseText(result)
            mediaUrl = medias.pagination.next_url;
            medias.data.eachWithIndex { media, j ->
                cooks.get(media.user.id, []) << 1
            };
        };
    }
    return cooks.findAll { it.value.size > 1 }.collect { it.key }
}

def filterCooks(cooks, mskFilter) {
    def moscowCooks = []
    cooks.eachWithIndex { cook, i ->
        def userUrl = "https://api.instagram.com/v1/users/" + cook + "?access_token=39949484.1fb234f.15ef9534744f42b68c22cf3b86b82687%20%20";
        def getUserPage = new URL(userUrl).openConnection() as HttpURLConnection
        getUserPage.connect()
        def result = IOUtils.toString(getUserPage.getInputStream()) as String
        def userInfo = new JsonSlurper().parseText(result)
        def bio = userInfo.data.bio.toLowerCase()
        if (mskFilter.any { bio.contains(it) } && bio.contains("@")) {
            moscowCooks.add(userInfo.data.id)
        }
        println "done " + i
    }
    return moscowCooks;
}

def parseCooks(cooks) {
    println "EMAIL, PASSWORD, CATALOG, SOURCE"
    cooks.each {
        def userUrl = "https://api.instagram.com/v1/users/" + it + "?access_token=39949484.1fb234f.15ef9534744f42b68c22cf3b86b82687%20%20";
        def getUserPage = new URL(userUrl).openConnection() as HttpURLConnection
        getUserPage.connect()
        def result = IOUtils.toString(getUserPage.getInputStream()) as String
        def userInfo = new JsonSlurper().parseText(result)
        def emailRg = userInfo.data.bio =~ "(\\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,4}\\b)"
        if (emailRg.size() > 0) {
            def email = emailRg[0][0]
            def password = "3mba07"
            def sourceUrl = "https://instagram.com/" + userInfo.data.username
            def catalogName = userInfo.data.full_name
            if (catalogName.size() == 0) catalogName = userInfo.data.username
            println email + "," + password + "," + catalogName + "," + sourceUrl
        }
    }
}

//println fetchCooks(tags);
//println filterCooks(cooks, filter)

parseCooks(localCooks)