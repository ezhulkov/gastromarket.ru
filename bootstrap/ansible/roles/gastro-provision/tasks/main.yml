---
  - name: make sure that nessesary directories exists
    file: path={{ item }} state=directory mode=0777 group=root owner=root
    with_items:
      - "/var/log/gastro"
      - "/var/lib/gastro"

  - hostname: name=gastromarket.ru
  - locale_gen: name=en_US.UTF-8 state=present
  - locale_gen: name=ru_RU.UTF-8 state=present

#Prepare
  - shell: sudo sh -c 'echo "deb http://nginx.org/packages/debian/ wheezy nginx" > /etc/apt/sources.list.d/nginx.list'
  - shell: sudo sh -c 'echo "deb-src http://nginx.org/packages/debian/ wheezy nginx" >> /etc/apt/sources.list.d/nginx.list'
  - shell: sudo sh -c 'echo "deb http://ppa.launchpad.net/webupd8team/java/ubuntu trusty main" > /etc/apt/sources.list.d/webupd8team-java.list'
  - shell: sudo sh -c 'echo "deb-src http://ppa.launchpad.net/webupd8team/java/ubuntu trusty main" >> /etc/apt/sources.list.d/webupd8team-java.list'
  - shell: apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys EEA14886
  - shell: apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys ABF5BD827BD9BF62

#Sys
  - apt: name={{ item }} force=yes
    with_items:
      - "sudo"
      - "mc"
      - "zsh"
      - "libpcre3"
      - "libpcre3-dev"
      - "libssl-dev"

#Java
  - apt: name=python-software-properties
  - shell: echo oracle-java8-installer shared/accepted-oracle-license-v1-1 select true | sudo /usr/bin/debconf-set-selections
  - apt: update_cache=yes
  - name: Install Java 8 and Set Java 8 Env
    apt: pkg={{ item }} state=latest install_recommends=yes
    with_items:
      - oracle-java8-installer
      - oracle-java8-set-default

#User
  - user: name=eugenezh comment="Eugene Zhulkov" group=sudo shell=/bin/zsh
  - authorized_key: user=eugenezh key="{{ lookup('file', '~/.ssh/id_rsa.pub') }}"

#Tomcat7
  - apt: name=tomcat7
  - service: name=tomcat7 state=stopped
  - copy: src=tomcat7/tomcat7 dest=/etc/default/tomcat7 owner=tomcat7 group=tomcat7 mode=0644
  - copy: src=tomcat7/server.xml dest=/etc/tomcat7/server.xml owner=tomcat7 group=tomcat7 mode=0644

#Postgres
  - shell: apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 7FCC7D46ACCC4CF8
  - shell: echo "deb http://apt.postgresql.org/pub/repos/apt/ wheezy-pgdg main" > /etc/apt/sources.list.d/pgdg.list
  - apt: update_cache=yes
  - apt: name=postgresql-9.4 force=yes
  - service: name=postgresql state=stopped
  - shell: sudo rm -fr /var/lib/postgresql/9.4/main/*
  - shell: sudo -u postgres /usr/lib/postgresql/9.4/bin/initdb --locale=ru_RU.UTF-8 /var/lib/postgresql/9.4/main
  - copy: src=postgres/russian.affix dest=/usr/share/postgresql/9.4/tsearch_data/russian.affix owner=postgres group=postgres mode=0644
  - copy: src=postgres/russian.dict dest=/usr/share/postgresql/9.4/tsearch_data/russian.dict owner=postgres group=postgres mode=0644
  - copy: src=postgres/russian.stop dest=/usr/share/postgresql/9.4/tsearch_data/russian.stop owner=postgres group=postgres mode=0644
  - copy: src=postgres/postgresql.conf dest=/etc/postgresql/9.4/main/postgresql.conf owner=postgres group=postgres mode=0644
  - copy: src=postgres/init.sql dest=/etc/postgresql/9.4/main/init.sql owner=postgres group=postgres mode=0644
  - service: name=postgresql state=started  enabled=yes
  - shell: sudo -u postgres psql -f /etc/postgresql/9.4/main/init.sql

#Nginx
  - group: name=nginx
  - user: name=nginx group=nginx
  - file: path="~/distr" state=directory mode=0755 group=root owner=root
  - get_url: url=http://www.grid.net.ru/nginx/download/nginx_upload_module-2.2.0.tar.gz dest=~/distr/nginx_upload_module-2.2.0.tar.gz
  - get_url: url=http://nginx.org/download/nginx-1.3.8.tar.gz dest=~/distr/nginx-1.3.8.tar.gz
  - unarchive: src=~/distr/nginx_upload_module-2.2.0.tar.gz dest=~/distr/ copy=false
  - unarchive: src=~/distr/nginx-1.3.8.tar.gz dest=~/distr/ copy=false
  - copy: src=nginx/nginx.patch dest=~/distr/nginx_upload_module-2.2.0/
  - shell: cd ~/distr/nginx_upload_module-2.2.0 && patch ngx_http_upload_module.c < nginx.patch
  - shell: cd ~/distr/nginx-1.3.8 &&
            ./configure --prefix=/usr/local/nginx --sbin-path=/usr/sbin/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log \
            --http-log-path=/var/log/nginx/access.log --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-file-aio \
            --with-ipv6 --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_gunzip_module --with-http_gzip_static_module \
            --with-http_stub_status_module --with-pcre --with-debug --add-module=/root/distr/nginx_upload_module-2.2.0 && \
            make && \
            make install
  - copy: src=nginx/nginx.conf dest=/etc/nginx/nginx.conf owner=nginx group=nginx mode=0644
  - copy: src=nginx/nginx-block.conf dest=/etc/nginx/nginx-block.conf owner=nginx group=nginx mode=0644
  - copy: src=nginx/nginx-core.conf dest=/etc/nginx/nginx-core.conf owner=nginx group=nginx mode=0644
  - copy: src=nginx/nginx dest=/etc/init.d/nginx owner=root group=root mode=0744
  - file: path={{ item }} state=directory mode=0755 group=nginx owner=nginx
    with_items:
      - "/var/lib/nginx/cache"
  - service: name=nginx state=started enabled=yes