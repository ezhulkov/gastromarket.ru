---
#Nginx
  - group: name=nginx
  - user: name=nginx group=nginx
  - file: path="~/distr" state=directory mode=0755 group=root owner=root
  - get_url: url=http://www.grid.net.ru/nginx/download/nginx_upload_module-2.2.0.tar.gz dest=~/distr/nginx_upload_module-2.2.0.tar.gz
  - get_url: url=http://nginx.org/download/nginx-1.3.8.tar.gz dest=~/distr/nginx-1.3.8.tar.gz
  - unarchive: src=~/distr/nginx_upload_module-2.2.0.tar.gz dest=~/distr/ copy=false
  - unarchive: src=~/distr/nginx-1.3.8.tar.gz dest=~/distr/ copy=false
  - copy: src=nginx.patch dest=~/distr/nginx_upload_module-2.2.0/
  - shell: cd ~/distr/nginx_upload_module-2.2.0 && patch ngx_http_upload_module.c < nginx.patch
  - shell: cd ~/distr/nginx-1.3.8 &&
            ./configure --prefix=/usr/local/nginx --sbin-path=/usr/sbin/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log \
            --http-log-path=/var/log/nginx/access.log --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-file-aio \
            --with-ipv6 --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_gunzip_module --with-http_gzip_static_module \
            --with-http_stub_status_module --with-pcre --with-debug --add-module=/root/distr/nginx_upload_module-2.2.0 && \
            make && \
            make install
  - template: src=nginx.conf dest=/etc/nginx/nginx.conf owner=nginx group=nginx mode=0644
  - copy: src=nginx-block.conf dest=/etc/nginx/nginx-block.conf owner=nginx group=nginx mode=0644
  - copy: src=nginx-core.conf dest=/etc/nginx/nginx-core.conf owner=nginx group=nginx mode=0644
  - copy: src=nginx dest=/etc/init.d/nginx owner=root group=root mode=0744
  - file: path={{ item }} state=directory mode=0755 group=nginx owner=nginx
    with_items:
      - "/var/lib/nginx/cache"
  - service: name=nginx state=started enabled=yes